<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decision Tree Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 24px;
            color: #1d1d1f;
        }

        .header {
            max-width: 1600px;
            margin: 0 auto 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 32px;
            border-radius: 8px;
            border: 1px solid #e5e5e7;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            min-height: calc(100vh - 140px);
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 32px;
            overflow-y: auto;
            border: 1px solid #e5e5e7;
            max-height: calc(100vh - 140px);
        }

        .panel::-webkit-scrollbar {
            width: 8px;
        }

        .panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel::-webkit-scrollbar-thumb {
            background: #d1d1d6;
            border-radius: 4px;
        }

        .panel::-webkit-scrollbar-thumb:hover {
            background: #b0b0b5;
        }

        .panel-header {
            color: #1d1d1f;
            margin-bottom: 24px;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e7;
        }

        .tree-view {
            margin-top: 20px;
        }

        .node {
            background: #fafafa;
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            padding: 20px;
            margin: 16px 0;
            transition: all 0.2s ease;
        }

        .node:hover {
            border-color: #c5c5c7;
        }

        .node.selected {
            border-color: #007aff;
            background: #f0f8ff;
        }

        .node-question {
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 16px;
            cursor: pointer;
            font-size: 15px;
            line-height: 1.5;
        }

        .node-question:hover {
            color: #007aff;
        }

        .option {
            background: white;
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            padding: 16px;
            margin: 12px 0 12px 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option:hover {
            border-color: #007aff;
            transform: translateX(4px);
        }

        .option-text {
            font-weight: 400;
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 6px;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .result-badge {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .link-badge {
            background: #e3f2fd;
            color: #1565c0;
        }

        .button-badge {
            background: #fff3e0;
            color: #e65100;
        }

        .youtube-badge {
            background: #ffebee;
            color: #c62828;
        }

        .editor-form {
            background: #fafafa;
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e5e5e7;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 500;
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 13px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #007aff;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.6;
        }

        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #0051d5;
        }

        button:active {
            transform: scale(0.98);
        }

        button.secondary {
            background: #8e8e93;
        }

        button.secondary:hover {
            background: #636366;
        }

        button.danger {
            background: #ff3b30;
        }

        button.danger:hover {
            background: #d62b1f;
        }

        button.success {
            background: #34c759;
        }

        button.success:hover {
            background: #248a3d;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .info-text {
            color: #8e8e93;
            font-size: 12px;
            margin-top: 6px;
        }

        .node-path {
            font-size: 12px;
            color: #007aff;
            margin-bottom: 16px;
            font-weight: 500;
            padding: 8px 12px;
            background: #f0f8ff;
            border-radius: 4px;
            border-left: 2px solid #007aff;
        }

        .divider {
            margin: 24px 0;
            padding-top: 24px;
            border-top: 1px solid #e5e5e7;
        }

        .save-indicator {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #34c759;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
            font-weight: 500;
            font-size: 14px;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 32px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .import-textarea {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 1px solid #d1d1d6;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            background: #fafafa;
            margin-bottom: 16px;
        }

        .import-textarea:focus {
            outline: none;
            border-color: #007aff;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e5e7;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .close-button {
            background: #8e8e93;
            padding: 8px 16px;
        }

        .code-output {
            background: #1d1d1f;
            color: #f5f5f7;
            padding: 24px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Decision Tree Editor</h1>
        <div class="header-actions">
            <button class="success" onclick="saveToStorage()">Save</button>
            <button class="secondary" onclick="loadFromStorage()">Load</button>
            <button onclick="showExportModal()">Export Code</button>
            <button class="danger" onclick="clearStorage()">Clear</button>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">Saved successfully</div>

    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Export Code</h2>
                <button class="close-button" onclick="hideExportModal()">Close</button>
            </div>
            <div class="code-output" id="codeOutput"></div>
            <button onclick="copyCode()">Copy to Clipboard</button>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Load Tree Data</h2>
                <button class="close-button" onclick="hideImportModal()">Close</button>
            </div>
            <div class="info-text" style="margin-bottom: 12px;">Paste the exported code below (including "const treeData = ...")</div>
            <textarea class="import-textarea" id="importTextarea" placeholder="const treeData = { ... };"></textarea>
            <div class="button-group">
                <button onclick="importTreeData()">Load Tree</button>
                <button class="secondary" onclick="hideImportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <div class="panel-header">Tree Structure</div>
            <div id="treeView" class="tree-view"></div>
        </div>

        <div class="panel">
            <div class="panel-header">Editor</div>
            <div id="editor"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'decisionTreeData';

        let treeData = {
            question: "What brings you here today?",
            options: [
                {
                    text: "I need to make a life decision",
                    next: {
                        question: "Is this decision urgent?",
                        options: [
                            {
                                text: "Yes, I need to decide soon",
                                next: {
                                    question: "Have you considered all options?",
                                    options: [
                                        {
                                            text: "Yes, thoroughly",
                                            result: "Trust your intuition. When you've done the work, your gut feeling often knows the answer.",
                                            link: "https://www.example.com/intuition-guide"
                                        },
                                        {
                                            text: "No, not really",
                                            result: "Take a moment to list all possibilities. Clarity comes from understanding what's available to you.",
                                            button: {
                                                text: "Decision Making Tool",
                                                url: "https://www.example.com/decision-tool"
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                text: "No, I have time",
                                result: "Let the decision breathe. Sleep on it for a few nights and notice what feels right in the morning.",
                                youtube: "dQw4w9WgXcQ"
                            }
                        ]
                    }
                },
                {
                    text: "I'm seeking clarity on a situation",
                    next: {
                        question: "Can you change the situation?",
                        options: [
                            {
                                text: "Yes, I have some control",
                                result: "Focus your energy on what you can influence. Let go of what you cannot."
                            },
                            {
                                text: "No, it's beyond my control",
                                result: "Acceptance is the path forward. Find peace in releasing what you cannot change."
                            }
                        ]
                    }
                },
                {
                    text: "I want to explore a possibility",
                    next: {
                        question: "What holds you back?",
                        options: [
                            {
                                text: "Fear of failure",
                                result: "Failure is simply feedback. Each attempt teaches you something valuable. Begin small if you must, but begin."
                            },
                            {
                                text: "Uncertainty about the path",
                                result: "The path reveals itself by walking. Take the first step, and the next will become clear."
                            },
                            {
                                text: "Resources or time",
                                result: "Start with what you have, where you are. Small consistent steps create extraordinary journeys."
                            }
                        ]
                    }
                }
            ]
        };

        let selectedPath = [];

        function init() {
            loadFromStorageAuto();
            renderTree();
        }

        function saveToStorage() {
            try {
                const dataStr = JSON.stringify(treeData);
                localStorage.setItem(STORAGE_KEY, dataStr);
                showSaveIndicator('Saved successfully');
            } catch (e) {
                alert('Error saving to storage: ' + e.message);
            }
        }

        function loadFromStorage() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('importTextarea').value = '';
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        function importTreeData() {
            try {
                const code = document.getElementById('importTextarea').value.trim();
                
                // Extract JSON from the code
                let jsonStr = code;
                
                // Remove "const treeData = " if present
                if (code.includes('const treeData =')) {
                    jsonStr = code.substring(code.indexOf('=') + 1).trim();
                }
                
                // Remove trailing semicolon if present
                if (jsonStr.endsWith(';')) {
                    jsonStr = jsonStr.slice(0, -1).trim();
                }
                
                // Parse the JSON
                const parsedData = JSON.parse(jsonStr);
                
                // Validate it has the right structure
                if (!parsedData.question || !parsedData.options) {
                    throw new Error('Invalid tree data structure');
                }
                
                treeData = parsedData;
                selectedPath = [];
                renderTree();
                hideImportModal();
                showSaveIndicator('Tree data loaded successfully');
            } catch (e) {
                alert('Error loading tree data: ' + e.message + '\n\nPlease make sure you pasted valid tree data.');
            }
        }

        function loadFromStorageAuto() {
            try {
                const dataStr = localStorage.getItem(STORAGE_KEY);
                if (dataStr) {
                    treeData = JSON.parse(dataStr);
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function clearStorage() {
            if (confirm('Are you sure you want to clear all saved data? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                treeData = {
                    question: "What brings you here today?",
                    options: [
                        {
                            text: "New option",
                            result: "New result"
                        }
                    ]
                };
                selectedPath = [];
                renderTree();
                showSaveIndicator('Storage cleared');
            }
        }

        function showSaveIndicator(message) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message || 'Saved successfully';
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function showExportModal() {
            const code = `const treeData = ${JSON.stringify(treeData, null, 4)};`;
            document.getElementById('codeOutput').textContent = code;
            document.getElementById('exportModal').classList.add('show');
        }

        function hideExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showSaveIndicator('Code copied');
            });
        }

        function renderTree() {
            const treeView = document.getElementById('treeView');
            treeView.innerHTML = '';
            renderNode(treeData, treeView, []);
        }

        function renderNode(node, container, path) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'node';
            
            if (arraysEqual(path, selectedPath)) {
                nodeDiv.className += ' selected';
            }

            const questionDiv = document.createElement('div');
            questionDiv.className = 'node-question';
            questionDiv.textContent = node.question;
            questionDiv.onclick = () => selectNode(path);
            nodeDiv.appendChild(questionDiv);

            if (node.options) {
                node.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';
                    
                    const optionPath = [...path, index];
                    
                    const textDiv = document.createElement('div');
                    textDiv.className = 'option-text';
                    textDiv.textContent = option.text;
                    optionDiv.appendChild(textDiv);

                    const badgesDiv = document.createElement('div');

                    if (option.result) {
                        const badge = document.createElement('span');
                        badge.className = 'badge result-badge';
                        badge.textContent = 'result';
                        badgesDiv.appendChild(badge);
                    }

                    if (option.link) {
                        const badge = document.createElement('span');
                        badge.className = 'badge link-badge';
                        badge.textContent = 'link';
                        badgesDiv.appendChild(badge);
                    }

                    if (option.button) {
                        const badge = document.createElement('span');
                        badge.className = 'badge button-badge';
                        badge.textContent = 'button';
                        badgesDiv.appendChild(badge);
                    }

                    if (option.youtube) {
                        const badge = document.createElement('span');
                        badge.className = 'badge youtube-badge';
                        badge.textContent = 'youtube';
                        badgesDiv.appendChild(badge);
                    }

                    optionDiv.appendChild(badgesDiv);
                    optionDiv.onclick = (e) => {
                        e.stopPropagation();
                        selectNode(optionPath);
                    };
                    nodeDiv.appendChild(optionDiv);

                    if (option.next) {
                        renderNode(option.next, optionDiv, optionPath);
                    }
                });
            }

            container.appendChild(nodeDiv);
        }

        function selectNode(path) {
            selectedPath = path;
            renderTree();
            showEditor(path);
        }

        function showEditor(path) {
            const editor = document.getElementById('editor');
            const node = getNodeAtPath(treeData, path);
            
            if (path.length === 0) {
                // Root question
                editor.innerHTML = `
                    <div class="editor-form">
                        <div class="node-path">Root Question</div>
                        <div class="form-group">
                            <label>Question Text</label>
                            <input type="text" id="questionInput" value="${escapeHtml(node.question)}">
                        </div>
                        <div class="button-group">
                            <button onclick="updateQuestion()">Update Question</button>
                            <button class="secondary" onclick="addOption()">Add Option</button>
                        </div>
                    </div>
                `;
            } else {
                // This is an option
                const option = node;
                const hasNext = !!option.next;
                
                editor.innerHTML = `
                    <div class="editor-form">
                        <div class="node-path">Path: ${path.join(' â†’ ')}</div>
                        <div class="form-group">
                            <label>Option Text</label>
                            <input type="text" id="optionText" value="${escapeHtml(option.text)}">
                        </div>
                        
                        ${!hasNext ? `
                        <div class="form-group">
                            <label>Result (optional)</label>
                            <textarea id="resultText">${escapeHtml(option.result || '')}</textarea>
                            <div class="info-text">Leave empty if this option leads to another question</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Link URL (optional)</label>
                            <input type="text" id="linkUrl" value="${escapeHtml(option.link || '')}">
                            <div class="info-text">Direct link shown below result</div>
                        </div>
                        
                        <div class="form-group">
                            <label>Button Text (optional)</label>
                            <input type="text" id="buttonText" value="${escapeHtml(option.button ? option.button.text : '')}">
                        </div>
                        
                        <div class="form-group">
                            <label>Button URL (optional)</label>
                            <input type="text" id="buttonUrl" value="${escapeHtml(option.button ? option.button.url : '')}">
                            <div class="info-text">Creates a clickable button</div>
                        </div>
                        
                        <div class="form-group">
                            <label>YouTube Video ID (optional)</label>
                            <input type="text" id="youtubeId" value="${escapeHtml(option.youtube || '')}">
                            <div class="info-text">e.g., "dQw4w9WgXcQ" from youtube.com/watch?v=dQw4w9WgXcQ</div>
                        </div>
                        ` : ''}
                        
                        <div class="button-group">
                            <button onclick="updateOption()">Update Option</button>
                            ${!hasNext ? `<button class="secondary" onclick="convertToQuestion()">Convert to Question</button>` : ''}
                            ${hasNext ? `<button class="danger" onclick="convertToResult()">Convert to Result</button>` : ''}
                            <button class="danger" onclick="deleteOption()">Delete Option</button>
                        </div>
                        
                        ${hasNext ? `
                        <div class="divider">
                            <h3 style="margin-bottom: 16px; font-size: 16px;">Sub-Question</h3>
                            <div class="form-group">
                                <label>Question Text</label>
                                <input type="text" id="subQuestion" value="${escapeHtml(option.next.question)}">
                            </div>
                            <div class="button-group">
                                <button onclick="updateSubQuestion()">Update Sub-Question</button>
                                <button class="secondary" onclick="addSubOption()">Add Sub-Option</button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getNodeAtPath(root, path) {
            if (path.length === 0) return root;
            
            let current = root;
            for (let i = 0; i < path.length; i++) {
                if (i === path.length - 1) {
                    return current.options[path[i]];
                } else {
                    current = current.options[path[i]].next;
                }
            }
            return current;
        }

        function getParentNodeAtPath(root, path) {
            if (path.length <= 1) return root;
            
            let current = root;
            for (let i = 0; i < path.length - 1; i++) {
                if (i === path.length - 2) {
                    return current.options[path[i]].next;
                } else {
                    current = current.options[path[i]].next;
                }
            }
            return current;
        }

        function updateQuestion() {
            const question = document.getElementById('questionInput').value;
            treeData.question = question;
            renderTree();
        }

        function addOption() {
            const node = selectedPath.length === 0 ? treeData : getNodeAtPath(treeData, selectedPath).next;
            if (!node.options) node.options = [];
            node.options.push({
                text: "New option",
                result: "New result"
            });
            renderTree();
        }

        function updateOption() {
            const option = getNodeAtPath(treeData, selectedPath);
            option.text = document.getElementById('optionText').value;
            
            const result = document.getElementById('resultText');
            if (result) {
                option.result = result.value || undefined;
                if (!option.result) delete option.result;
            }
            
            const link = document.getElementById('linkUrl');
            if (link) {
                option.link = link.value || undefined;
                if (!option.link) delete option.link;
            }
            
            const buttonText = document.getElementById('buttonText');
            const buttonUrl = document.getElementById('buttonUrl');
            if (buttonText && buttonUrl) {
                if (buttonText.value && buttonUrl.value) {
                    option.button = {
                        text: buttonText.value,
                        url: buttonUrl.value
                    };
                } else {
                    delete option.button;
                }
            }
            
            const youtube = document.getElementById('youtubeId');
            if (youtube) {
                option.youtube = youtube.value || undefined;
                if (!option.youtube) delete option.youtube;
            }
            
            renderTree();
        }

        function deleteOption() {
            if (selectedPath.length === 0) {
                alert("Cannot delete root node");
                return;
            }
            
            if (!confirm("Are you sure you want to delete this option?")) {
                return;
            }
            
            const parentPath = selectedPath.slice(0, -1);
            const index = selectedPath[selectedPath.length - 1];
            const parent = parentPath.length === 0 ? treeData : getNodeAtPath(treeData, parentPath).next;
            
            parent.options.splice(index, 1);
            selectedPath = [];
            renderTree();
        }

        function convertToQuestion() {
            const option = getNodeAtPath(treeData, selectedPath);
            option.next = {
                question: "New question?",
                options: [
                    { text: "Option 1", result: "Result 1" },
                    { text: "Option 2", result: "Result 2" }
                ]
            };
            delete option.result;
            delete option.link;
            delete option.button;
            delete option.youtube;
            renderTree();
        }

        function convertToResult() {
            const option = getNodeAtPath(treeData, selectedPath);
            option.result = "New result";
            delete option.next;
            renderTree();
        }

        function updateSubQuestion() {
            const option = getNodeAtPath(treeData, selectedPath);
            option.next.question = document.getElementById('subQuestion').value;
            renderTree();
        }

        function addSubOption() {
            const option = getNodeAtPath(treeData, selectedPath);
            if (!option.next.options) option.next.options = [];
            option.next.options.push({
                text: "New sub-option",
                result: "New result"
            });
            renderTree();
        }

        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, index) => val === b[index]);
        }

        init();
    </script>
</body>
</html>
